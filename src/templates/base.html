<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Church Management System{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', path='css/custom.css') }}" rel="stylesheet">
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    {% block head %}{% endblock %}
  </head>

  <body class="bg-gray-50 min-h-screen" x-data>
    {% if user %}
    <!-- Sidebar Navigation -->
    <div class="flex h-screen bg-gray-50" x-data="{ sidebarOpen: false }">
      <!-- Sidebar -->
      <div class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0"
           :class="{ '-translate-x-full': !sidebarOpen, 'translate-x-0': sidebarOpen }">
        <!-- Sidebar Header -->
        <div class="flex items-center justify-between h-16 px-6 border-b border-gray-200">
          <div class="flex items-center space-x-2">
            <i class="fas fa-church text-blue-600 text-2xl"></i>
            <span class="text-xl font-bold text-gray-800">ChurchMS</span>
          </div>
          <button @click="sidebarOpen = false" class="lg:hidden">
            <i class="fas fa-times text-gray-500"></i>
          </button>
        </div>

        <!-- Navigation Menu -->
        <nav class="mt-6 px-3">
          <div class="space-y-1">
            <!-- Dashboard -->
            <a href="{{ url_for('dashboard') }}"
               class="group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200
                      {% if request.url.path == '/ui/dashboard' %}bg-blue-100 text-blue-700 border-r-2 border-blue-500
                      {% else %}text-gray-700 hover:bg-gray-100 hover:text-gray-900{% endif %}">
              <i class="fas fa-tachometer-alt mr-3 text-lg"></i>
              Dashboard
            </a>

            <!-- Members -->
            <div class="space-y-1">
              <a href="{{ url_for('members_dashboard') }}"
                 class="group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200
                        {% if '/members' in request.url.path %}bg-blue-100 text-blue-700 border-r-2 border-blue-500
                        {% else %}text-gray-700 hover:bg-gray-100 hover:text-gray-900{% endif %}">
                <i class="fas fa-users mr-3 text-lg"></i>
                Members
              </a>
              <div class="ml-6 space-y-1">
                <a href="{{ url_for('members_dashboard') }}"
                   class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                  Overview
                </a>
                <a href="{{ url_for('members_list') }}"
                   class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                  All Members
                </a>
                <a href="{{ url_for('create_member_form') }}"
                   class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                  Add Member
                </a>
              </div>
            </div>

            <!-- Attendance -->
            <div class="space-y-1">
              <a href="{{ url_for('attendance_dashboard') }}"
                 class="group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200
                        {% if '/attendance' in request.url.path %}bg-blue-100 text-blue-700 border-r-2 border-blue-500
                        {% else %}text-gray-700 hover:bg-gray-100 hover:text-gray-900{% endif %}">
                <i class="fas fa-clipboard-check mr-3 text-lg"></i>
                Attendance
              </a>
              <div class="ml-6 space-y-1">
                <a href="{{ url_for('attendance_dashboard') }}"
                   class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                  Overview
                </a>
                <a href="{{ url_for('attendance_list') }}"
                   class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                  All Records
                </a>
                <a href="{{ url_for('create_attendance_form') }}"
                   class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                  Record Attendance
                </a>
              </div>
            </div>

            <!-- Events -->
            <div class="space-y-1">
              <a href="{{ url_for('events_dashboard') }}"
                 class="group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200
                        {% if '/events' in request.url.path %}bg-blue-100 text-blue-700 border-r-2 border-blue-500
                        {% else %}text-gray-700 hover:bg-gray-100 hover:text-gray-900{% endif %}">
                <i class="fas fa-calendar mr-3 text-lg"></i>
                Events
              </a>
              <div class="ml-6 space-y-1">
                <a href="{{ url_for('events_dashboard') }}"
                   class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                  Overview
                </a>
                <a href="{{ url_for('events_list') }}"
                   class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                  All Events
                </a>
                <a href="{{ url_for('create_event_form') }}"
                   class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                  Add Event
                </a>
              </div>
            </div>

            <!-- Admin Section -->
            {% if user.is_admin and user.is_active %}
            <div class="pt-4 mt-4 border-t border-gray-200">
              <div class="space-y-1">
                <a href="{{ url_for('admin_dashboard') }}"
                   class="group flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200
                          {% if '/admin' in request.url.path %}bg-red-100 text-red-700 border-r-2 border-red-500
                          {% else %}text-gray-700 hover:bg-gray-100 hover:text-gray-900{% endif %}">
                  <i class="fas fa-cog mr-3 text-lg"></i>
                  Administration
                </a>
                <div class="ml-6 space-y-1">
                  <a href="{{ url_for('admin_dashboard') }}"
                     class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                    Dashboard
                  </a>
                  <a href="{{ url_for('admin_users') }}"
                     class="block px-3 py-2 text-xs font-medium text-gray-500 hover:text-gray-700 rounded-md">
                    User Management
                  </a>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </nav>

        <!-- User Profile Section -->
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200">
          <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-white text-sm"></i>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate">{{ user.username }}</p>
              <p class="text-xs text-gray-500 truncate">
                {% if user.is_admin %}Administrator{% else %}Member{% endif %}
              </p>
            </div>
            <div class="flex-shrink-0" x-data="{ open: false }">
              <button @click="open = !open" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <div x-show="open" @click.away="open = false"
                   class="absolute bottom-full right-0 mb-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                <a href="{{ url_for('profile') }}"
                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                  <i class="fas fa-user-edit mr-2"></i>Profile
                </a>
                <button onclick="logout()" type="button"
                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                  <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile sidebar overlay -->
      <div x-show="sidebarOpen" @click="sidebarOpen = false"
           class="fixed inset-0 z-40 bg-gray-600 bg-opacity-75 lg:hidden"
           x-transition:enter="transition-opacity ease-linear duration-300"
           x-transition:enter-start="opacity-0"
           x-transition:enter-end="opacity-100"
           x-transition:leave="transition-opacity ease-linear duration-300"
           x-transition:leave-start="opacity-100"
           x-transition:leave-end="opacity-0"></div>

      <!-- Main Content Area -->
      <div class="flex-1 flex flex-col overflow-hidden lg:ml-0">
        <!-- Top Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
          <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
            <div class="flex items-center">
              <button @click="sidebarOpen = true" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                <i class="fas fa-bars text-lg"></i>
              </button>
              <h1 class="ml-2 lg:ml-0 text-xl font-semibold text-gray-900">
                {% block page_title %}Dashboard{% endblock %}
              </h1>
            </div>
            <div class="flex items-center space-x-4">
              <!-- Notifications -->
              <button class="p-2 text-gray-400 hover:text-gray-500 hover:bg-gray-100 rounded-md">
                <i class="fas fa-bell text-lg"></i>
              </button>
              <!-- Quick Actions -->
              <div class="hidden md:flex items-center space-x-2">
                <a href="{{ url_for('create_member_form') }}"
                   class="bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">
                  <i class="fas fa-user-plus mr-1"></i>Add Member
                </a>
                <a href="{{ url_for('create_event_form') }}"
                   class="bg-purple-600 text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-purple-700 transition-colors">
                  <i class="fas fa-calendar-plus mr-1"></i>Add Event
                </a>
              </div>
            </div>
          </div>
        </header>

        <!-- Page Content -->
        <main class="flex-1 overflow-y-auto">
          <div class="py-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
              {% block content %}{% endblock %}
            </div>
          </div>
        </main>
      </div>
    </div>

    {% else %}
    <!-- Landing Page Layout (No Sidebar) -->
    <div class="min-h-screen bg-gray-50">
      <!-- Top Navigation for Landing Page -->
      <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
          <div class="flex justify-between h-16">
            <div class="flex items-center">
              <a href="{{ url_for('home') }}" class="flex items-center space-x-2">
                <i class="fas fa-church text-blue-600 text-2xl"></i>
                <span class="text-xl font-bold text-gray-800">ChurchMS</span>
              </a>
            </div>
            <div class="flex items-center space-x-4">
              <a href="{{ url_for('login') }}"
                 class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-sign-in-alt mr-1"></i>Login
              </a>
              <a href="{{ url_for('register') }}"
                 class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                <i class="fas fa-user-plus mr-1"></i>Register
              </a>
            </div>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        {{ self.content() }}
      </main>
    </div>
    {% endif %}

    <!-- Global Toasts -->
    <div x-data="toastStore" class="fixed top-4 right-4 z-50 space-y-2">
      <template x-for="toast in toasts" :key="toast.id">
        <div :class="['px-4 py-3 rounded shadow border', toast.type === 'error' ? 'bg-red-50 border-red-300 text-red-800' : 'bg-green-50 border-green-300 text-green-800']">
          <div class="flex items-start">
            <i :class="['mt-0.5 mr-2', toast.type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-check-circle']"></i>
            <div class="text-sm" x-text="toast.message"></div>
          </div>
        </div>
      </template>
    </div>

    <!-- Confirm Modal -->
    <div x-data="confirmModalStore" x-show="open" class="fixed inset-0 z-50 flex items-center justify-center" style="display:none">
      <div class="absolute inset-0 bg-black bg-opacity-40" @click="cancel()"></div>
      <div class="relative bg-white rounded-lg shadow-lg max-w-sm w-full mx-4 p-5">
        <h3 class="text-lg font-semibold text-gray-900" x-text="title"></h3>
        <p class="mt-2 text-sm text-gray-600" x-text="message"></p>
        <div class="mt-5 flex items-center justify-end space-x-2">
          <button @click="cancel()" class="px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Cancel</button>
          <button @click="confirm()" class="px-3 py-2 text-sm bg-purple-600 text-white rounded hover:bg-purple-700">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      // CSRF token for forms
      function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
      }

      // Logout function
      async function logout() {
        try {
          // Clear localStorage tokens
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
          localStorage.removeItem('token_expires_at');

          // Clear cookies
          document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
          document.cookie = 'refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';

          // Call API logout to clear server-side session
          try {
            const response = await fetch('{{ url_for("api_logout") }}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              }
            });
          } catch (apiError) {
            // API logout failed, continuing with redirect
          }

          // Redirect to login UI page (/ui/login)
          const loginUrl = '{{ url_for("login") }}';

          // Ensure we're going to the UI login page
          if (!loginUrl.includes('/ui/login')) {
            window.location.replace('{{ url_for("login") }}');
          } else {
            // Try multiple redirect methods
            try {
              window.location.replace(loginUrl);
            } catch (replaceError) {
              window.location.href = loginUrl;
            }
          }
        } catch (error) {
          // Fallback: redirect to login UI page
          window.location.href = '{{ url_for("login") }}';
        }
      }

      // Token refresh function
      async function refreshAccessToken() {
        const refreshToken = localStorage.getItem('refresh_token');
        if (!refreshToken) {
          return false;
        }

        try {
          const response = await fetch('{{ url_for("api_refresh") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ refresh_token: refreshToken })
          });

          if (response.ok) {
            const data = await response.json();
            localStorage.setItem('access_token', data.access_token);
            localStorage.setItem('token_expires_at', Date.now() + (data.expires_in * 1000));
            return true;
          } else {
            // Refresh token is invalid, logout user
            logout();
            window.location.href = '{{ url_for("login") }}';
            return false;
          }
        } catch (error) {
          logout();
          window.location.href = '{{ url_for("login") }}';
          return false;
        }
      }

      // Check if token needs refresh and refresh if necessary
      async function checkAndRefreshToken() {
        const tokenExpiresAt = localStorage.getItem('token_expires_at');
        if (!tokenExpiresAt) {
          return false;
        }

        const expiresAt = parseInt(tokenExpiresAt);
        const now = Date.now();
        const timeUntilExpiry = expiresAt - now;

        // Refresh token if it expires in the next 5 minutes
        if (timeUntilExpiry < 5 * 60 * 1000) {
          return await refreshAccessToken();
        }

        return true;
      }

      // Auto-refresh token every 5 minutes
      setInterval(checkAndRefreshToken, 5 * 60 * 1000);

      // API helper
      async function apiCall(url, options = {}) {
        // Check and refresh token if needed before making request
        await checkAndRefreshToken();

        const token = localStorage.getItem('access_token');
        const defaultOptions = {
          headers: {
            'Content-Type': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` })
          }
        };

        const response = await fetch(url, { ...defaultOptions, ...options });

        if (response.status === 401) {
          // Try to refresh token once more
          const refreshed = await refreshAccessToken();
          if (refreshed) {
            // Retry the request with new token
            const newToken = localStorage.getItem('access_token');
            const retryOptions = {
              ...defaultOptions,
              headers: {
                ...defaultOptions.headers,
                'Authorization': `Bearer ${newToken}`
              }
            };
            return await fetch(url, { ...retryOptions, ...options });
          } else {
            // Refresh failed, redirect to login
            window.location.href = '{{ url_for("login") }}';
            return;
          }
        }

        return response;
      }

      // Date formatting helper: e.g., 14 Aug 2025
      function formatDate(dateString) {
        try {
          if (!dateString) return '';
          const d = new Date(dateString);
          // Ensure valid date
          if (Number.isNaN(d.getTime())) return dateString;
          return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch (_) {
          return dateString || '';
        }
      }

      // HTML rendering helper (sanitized)
      function renderHtml(html) {
        try {
          if (!html) return '';
          return window.DOMPurify ? window.DOMPurify.sanitize(html, { USE_PROFILES: { html: true } }) : html;
        } catch (_) {
          return html;
        }
      }

      // Toast store
      document.addEventListener('alpine:init', () => {
        Alpine.data('toastStore', () => ({
          toasts: [],
          add(message, type = 'success', timeoutMs = 4000) {
            const id = Date.now() + Math.random();
            this.toasts.push({ id, message, type });
            setTimeout(() => { this.toasts = this.toasts.filter(t => t.id !== id); }, timeoutMs);
          }
        }));

        Alpine.data('confirmModalStore', () => ({
          open: false,
          title: 'Please confirm',
          message: 'Are you sure?',
          _resolve: null,
          _reject: null,
          ask(title, message) {
            this.title = title || 'Please confirm';
            this.message = message || 'Are you sure?';
            this.open = true;
            return new Promise((resolve, reject) => { this._resolve = resolve; this._reject = reject; });
          },
          confirm() { this.open = false; if (this._resolve) this._resolve(true); },
          cancel() { this.open = false; if (this._resolve) this._resolve(false); }
        }));
      });
    </script>
  </body>

</html>
