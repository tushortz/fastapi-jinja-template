{% extends "base.html" %}

{% block title %}Record Attendance{% endblock %}
{% block page_title %}Record Attendance{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
  <div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-900">Record Attendance</h1>
        <a href="{{ url_for('attendance_list') }}"
           class="text-gray-600 hover:text-gray-800">
          <i class="fas fa-arrow-left mr-2"></i>Back to Records
        </a>
      </div>
    </div>

    <form id="attendanceForm" class="p-6 space-y-6">
      <!-- Member Information -->
      <div class="bg-gray-50 p-4 rounded-lg" x-data="memberSearch()">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Member Information</h2>
        <div class="relative">
          <label for="member_search" class="block text-sm font-medium text-gray-700 mb-1">Search Member *</label>
          <input type="text" id="member_search" x-model="query" @input.debounce.300ms="search"
                 placeholder="Type first or last name..."
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                 autocomplete="off">
          <input type="hidden" id="member_id" name="member_id" x-model="selectedMemberId" required>

          <!-- Results dropdown -->
          <div x-show="open && results.length > 0" @click.away="open = false"
               class="absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto">
            <template x-for="member in results" :key="member.id">
              <button type="button" @click="choose(member)"
                      class="w-full text-left px-3 py-2 hover:bg-gray-50 flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-900" x-text="member.first_name + ' ' + (member.last_name || '')"></p>
                  <p class="text-xs text-gray-500" x-text="member.email || ''"></p>
                </div>
                <span class="text-xs text-gray-400" x-text="member.id"></span>
              </button>
            </template>
          </div>

          <!-- Chosen member pill -->
          <div x-show="selectedMemberName" class="mt-2 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            <i class="fas fa-user mr-1"></i>
            <span x-text="selectedMemberName"></span>
            <button type="button" class="ml-2 text-blue-600 hover:text-blue-800" @click="clearSelection()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Recent attendance for selected member -->
        <div x-show="selectedMemberId && recent.length > 0" class="mt-4">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Recent Attendance</h3>
          <ul class="divide-y divide-gray-200 bg-white rounded border">
            <template x-for="att in recent" :key="att.id">
              <li class="px-3 py-2 text-sm text-gray-700 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800" x-text="att.attendance_type.replace('_',' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
                  <span x-text="att.attendance_date"></span>
                </div>
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                      :class="{
                        'bg-green-100 text-green-800': att.status==='present',
                        'bg-yellow-100 text-yellow-800': att.status==='late' || att.status==='excused',
                        'bg-red-100 text-red-800': att.status==='absent'
                      }"
                      x-text="att.status.replace('_',' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
              </li>
            </template>
          </ul>
        </div>
      </div>

      <!-- Service Information -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Service Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="attendance_date" class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
            <input type="date" id="attendance_date" name="attendance_date" required
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div x-data="enumSelect('/api/attendance/enums/types')">
            <label for="attendance_type" class="block text-sm font-medium text-gray-700 mb-1">Service Type *</label>
            <select id="attendance_type" name="attendance_type" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select Service Type</option>
              <template x-for="v in values" :key="v">
                <option :value="v" x-text="v.replace('_',' ').replace(/\b\w/g, l => l.toUpperCase())"></option>
              </template>
            </select>
          </div>
          <!-- service_time removed -->
          <div x-data="enumSelect('/api/attendance/enums/statuses')">
            <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Attendance Status *</label>
            <select id="status" name="status" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select Status</option>
              <template x-for="v in values" :key="v">
                <option :value="v" x-text="v.replace('_',' ').replace(/\b\w/g, l => l.toUpperCase())"></option>
              </template>
            </select>
          </div>
        </div>
      </div>

      <!-- Additional Information -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Additional Information</h2>
        <div>
          <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
          <textarea id="notes" name="notes" rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Any additional notes about the attendance..."></textarea>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
        <a href="{{ url_for('attendance_list') }}"
           class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
          Cancel
        </a>
        <button type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          <i class="fas fa-save mr-2"></i>Record Attendance
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Set default date to today
document.getElementById('attendance_date').value = new Date().toISOString().split('T')[0];

// Generic enum loader for Alpine x-data
function enumSelect(endpoint) {
  return {
    values: [],
    async init() {
      try {
        const res = await apiCall(endpoint);
        if (res.ok) {
          this.values = await res.json();
        }
      } catch (e) {
        console.error('Failed to load enum values from', endpoint, e);
        this.values = [];
      }
    }
  }
}

document.getElementById('attendanceForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());

  // Remove empty fields
  Object.keys(data).forEach(key => {
    if (data[key] === '') {
      delete data[key];
    }
  });

  try {
    if (!data.member_id) {
      Alpine.store('toastStore')?.add('Please select a member from the search results.', 'error');
      return;
    }

    const response = await apiCall('/api/attendance/', {
      method: 'POST',
      body: JSON.stringify(data)
    });

    if (response.ok) {
      const attendance = await response.json();
      window.location.href = '/dashboard/attendance/list';
    } else {
      const error = await response.json();
      Alpine.store('toastStore')?.add('Error recording attendance: ' + (error.detail || 'Unknown error'), 'error');
    }
  } catch (error) {
    console.error('Error:', error);
    Alpine.store('toastStore')?.add('Error recording attendance. Please try again.', 'error');
  }
});

function memberSearch() {
  return {
    query: '',
    results: [],
    open: false,
    selectedMemberId: '',
    selectedMemberName: '',
    recent: [],

    async search() {
      this.open = !!this.query && this.query.length >= 2;
      if (!this.open) {
        this.results = [];
        return;
      }
      try {
        const params = new URLSearchParams({ search: this.query, limit: '10' });
        const res = await apiCall(`/api/members/?${params.toString()}`);
        if (res.ok) {
          this.results = await res.json();
        } else {
          this.results = [];
        }
      } catch (e) {
        this.results = [];
      }
    },

    choose(member) {
      this.selectedMemberId = member.id;
      this.selectedMemberName = `${member.first_name} ${member.last_name || ''}`.trim();
      this.query = this.selectedMemberName;
      this.open = false;
      this.results = [];
      this.loadRecent();
    },

    clearSelection() {
      this.selectedMemberId = '';
      this.selectedMemberName = '';
      this.query = '';
      this.results = [];
      this.open = false;
      this.recent = [];
    },

    async loadRecent() {
      if (!this.selectedMemberId) return;
      try {
        const res = await apiCall(`/api/attendance/member/${this.selectedMemberId}?limit=5`);
        if (res.ok) {
          this.recent = await res.json();
        } else {
          this.recent = [];
        }
      } catch (_) {
        this.recent = [];
      }
    }
  }
}
</script>
{% endblock %}
